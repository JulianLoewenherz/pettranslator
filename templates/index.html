<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Mind Reader</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
    <!-- Background Elements -->
    <div class="background-gradient"></div>
    <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <!-- Main Container -->
    <div class="glass-container">
        <!-- Upload State -->
        <div id="upload-state" class="state-container">
            <div class="glass-card upload-card">
                <div class="card-header">
                    <h1>Pet Mind Reader</h1>
                    <p>Upload your pet's video to discover their thoughts</p>
                </div>
                
            <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">+</div>
                        <p class="upload-text">Drop your video here or click to browse</p>
                        <p class="upload-hint">MP4, MOV, AVI ‚Ä¢ Max 10 seconds ‚Ä¢ Up to 50MB</p>
                        <input type="file" id="video-file" name="file" accept=".mp4,.mov,.avi,.mkv,.webm" required>
                </div>

                    <button type="submit" class="glass-button" id="analyzeBtn" disabled>
                        <span>Analyze Pet's Mind</span>
                </button>
            </form>
            </div>
            </div>

        <!-- Processing State -->
        <div id="processing-state" class="state-container hidden">
            <div class="glass-card processing-card">
                <div class="processing-animation">
                    <div class="brain-icon">‚Ä¢</div>
                    <div class="pulse-rings">
                        <div class="ring ring-1"></div>
                        <div class="ring ring-2"></div>
                        <div class="ring ring-3"></div>
                    </div>
                </div>
                <h2>Analyzing your pet's behavior...</h2>
                <p class="processing-text">Stage 1: Observing behaviors ‚Ä¢ Stage 2: Clinical assessment</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="processing-time">This may take 30-60 seconds</p>
            </div>
        </div>

        <!-- Results State -->
        <div id="results-state" class="state-container hidden">
            <div class="glass-card results-card">
                <div class="video-container">
                    <video id="resultVideo" controls loop muted>
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="video-overlay">
                        <div class="pet-type-badge" id="petTypeBadge">Dog</div>
                    </div>
                </div>
                
                <div class="analysis-container">
                    <!-- Stage 1: Video Description -->
                    <div class="analysis-stage" id="stage1">
                        <div class="stage-header">
                            <h3>üìπ Video Analysis</h3>
                            <span class="stage-badge">Stage 1</span>
                        </div>
                        <div class="video-description">
                            <div class="description-text" id="videoDescriptionText">
                                <!-- Video description will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading Screen between stages -->
                    <div class="analysis-stage loading-stage hidden" id="loadingStage">
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <h3>üß† Analyzing video and consulting research papers...</h3>
                            <p>Finding relevant behavioral insights from veterinary research</p>
                        </div>
                    </div>
                    
                    <!-- Stage 2: Clinical Analysis -->
                    <div class="analysis-stage hidden" id="stage2">
                        <div class="stage-header">
                            <h3>üêæ What Your Pet is Thinking</h3>
                            <span class="stage-badge">Stage 2</span>
                        </div>
                        <div class="clinical-analysis">
                            <div class="clinical-text" id="clinicalText">
                                <!-- Clinical analysis will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Debug Panel -->
                    <div class="debug-panel hidden" id="debugPanel">
                        <div class="debug-header">
                            <h4>üîç Debug: RAG Insights Used</h4>
                            <button class="debug-toggle" id="debugToggle">Show Debug Info</button>
                        </div>
                        <div class="debug-content hidden" id="debugContent">
                            <!-- Debug information will appear here -->
                        </div>
                    </div>
                    
                    <div class="video-info" id="videoInfo">
                        <!-- Video metadata will appear here -->
                    </div>
                </div>
                
                <button class="glass-button secondary" id="analyzeAnotherBtn">
                    <span>Analyze Another Video</span>
                </button>
            </div>
                </div>

        <!-- Error State -->
        <div id="error-state" class="state-container hidden">
            <div class="glass-card error-card">
                <div class="error-icon">!</div>
                <h2>Something went wrong</h2>
                <p class="error-message" id="errorMessage">
                    <!-- Error message will appear here -->
                </p>
                <button class="glass-button secondary" id="tryAgainBtn">
                    <span>Try Again</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // State management
        const states = {
            upload: document.getElementById('upload-state'),
            processing: document.getElementById('processing-state'),
            results: document.getElementById('results-state'),
            error: document.getElementById('error-state')
        };

        // Form elements
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('video-file');
        const uploadZone = document.getElementById('uploadZone');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analyzeAnotherBtn = document.getElementById('analyzeAnotherBtn');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        
        // Result elements
        const resultVideo = document.getElementById('resultVideo');
        const videoDescriptionText = document.getElementById('videoDescriptionText');
        const clinicalText = document.getElementById('clinicalText');
        const petTypeBadge = document.getElementById('petTypeBadge');
        const videoInfo = document.getElementById('videoInfo');
        const errorMessage = document.getElementById('errorMessage');
        const progressFill = document.getElementById('progressFill');
        
        // Stage elements
        const stage1 = document.getElementById('stage1');
        const loadingStage = document.getElementById('loadingStage');
        const stage2 = document.getElementById('stage2');
        const debugPanel = document.getElementById('debugPanel');
        const debugToggle = document.getElementById('debugToggle');
        const debugContent = document.getElementById('debugContent');

        // Current video blob for playback
        let currentVideoBlob = null;

        // State switching function
        function showState(stateName) {
            Object.values(states).forEach(state => state.classList.add('hidden'));
            states[stateName].classList.remove('hidden');
        }

        // File upload handling
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            fileInput.files = e.dataTransfer.files;
            handleFileSelection();
        });

        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection() {
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                uploadZone.classList.add('file-selected');
                uploadZone.querySelector('.upload-text').textContent = file.name;
                analyzeBtn.disabled = false;
                
                // Create blob URL for later video playback
                currentVideoBlob = URL.createObjectURL(file);
            } else {
                uploadZone.classList.remove('file-selected');
                uploadZone.querySelector('.upload-text').textContent = 'Drop your video here or click to browse';
                analyzeBtn.disabled = true;
                currentVideoBlob = null;
            }
        }

        // Progress simulation
        function simulateProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressFill.style.width = progress + '%';
                
                if (progress >= 90) {
                    clearInterval(interval);
                }
            }, 1000);
            return interval;
        }

        // Typewriter effect for AI response
        function typewriterEffect(text, element, speed = 50) {
            element.textContent = '';
            let i = 0;
            const timer = setInterval(() => {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                } else {
                    clearInterval(timer);
            }
            }, speed);
        }

        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            // Switch to processing state
            showState('processing');
            const progressInterval = simulateProgress();
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Complete progress bar
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                if (response.ok && data.success) {
                    // Wait a moment then show results
                    setTimeout(() => {
                        showResults(data);
                    }, 1000);
                } else {
                    // Show error
                    showError(data.error || data.detail || 'Analysis failed');
                }
            } catch (err) {
                clearInterval(progressInterval);
                showError('Network error: ' + err.message);
            }
        });

        function showResults(data) {
            // Set up video playback
            resultVideo.src = currentVideoBlob;
            resultVideo.load();
            
            // Set pet type badge
            petTypeBadge.textContent = data.pet_type.charAt(0).toUpperCase() + data.pet_type.slice(1);
            
            // Set video info
            videoInfo.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Duration:</span>
                    <span class="info-value">${data.video_info.duration}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Size:</span>
                    <span class="info-value">${data.video_info.size}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Analyzed:</span>
                    <span class="info-value">${new Date(data.timestamp).toLocaleString()}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Search Queries:</span>
                    <span class="info-value">${data.debug_info ? data.debug_info.behaviors_detected : 0}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Research Insights:</span>
                    <span class="info-value">${data.debug_info ? data.debug_info.research_insights_found : 0}</span>
                </div>
            `;
            
            // Show results state
            showState('results');
            
            // Start video playback
            resultVideo.currentTime = 0;
            resultVideo.play().catch(e => {
                console.log('Auto-play blocked, user will need to click play');
            });
            
            // Sequential stage display
            // Stage 1: Show video description immediately
            stage1.classList.remove('hidden');
            loadingStage.classList.add('hidden');
            stage2.classList.add('hidden');
            
            setTimeout(() => {
                const descriptionText = `${data.stage1_description || 'Video analysis in progress...'}`;
                typewriterEffect(descriptionText, videoDescriptionText, 40);
            }, 500);
            
            // Stage 2: Show loading screen, then clinical analysis
            setTimeout(() => {
                stage1.classList.add('hidden');
                loadingStage.classList.remove('hidden');
            }, 3000);
            
            setTimeout(() => {
                loadingStage.classList.add('hidden');
                stage2.classList.remove('hidden');
                debugPanel.classList.remove('hidden');
                
                const clinicalResponse = data.stage2_clinical_analysis || 'Analysis in progress...';
                typewriterEffect(clinicalResponse, clinicalText, 60);
                
                // Populate debug panel
                if (data.debug_info && data.debug_info.top_insights) {
                    populateDebugPanel(data.debug_info);
                }
            }, 5000);
        }
        
        function populateDebugPanel(debugInfo) {
            const debugHTML = `
                <div class="debug-stats">
                    <p><strong>Behaviors Detected:</strong> ${debugInfo.behaviors_detected}</p>
                    <p><strong>Research Insights Found:</strong> ${debugInfo.research_insights_found}</p>
                </div>
                <div class="debug-insights">
                    <h5>Top Research Insights Used:</h5>
                    ${debugInfo.top_insights.map((insight, index) => `
                        <div class="debug-insight">
                            <div class="insight-header">
                                <span class="insight-number">${index + 1}.</span>
                                <span class="insight-behavior">${insight.behavior}</span>
                                <span class="insight-confidence confidence-${insight.confidence}">${insight.confidence}</span>
                            </div>
                            <div class="insight-details">
                                <p><strong>Meaning:</strong> ${insight.meaning}</p>
                                <p><strong>Similarity:</strong> ${insight.similarity}</p>
                                <p><strong>Source:</strong> ${insight.source}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            debugContent.innerHTML = debugHTML;
        }

        function showError(message) {
            errorMessage.textContent = message;
            showState('error');
        }

        // Reset buttons
        analyzeAnotherBtn.addEventListener('click', () => {
            showState('upload');
            form.reset();
            handleFileSelection();
            if (currentVideoBlob) {
                URL.revokeObjectURL(currentVideoBlob);
                currentVideoBlob = null;
            }
        });

        tryAgainBtn.addEventListener('click', () => {
            showState('upload');
        });

        // Debug panel toggle
        debugToggle.addEventListener('click', () => {
            if (debugContent.classList.contains('hidden')) {
                debugContent.classList.remove('hidden');
                debugToggle.textContent = 'Hide Debug Info';
            } else {
                debugContent.classList.add('hidden');
                debugToggle.textContent = 'Show Debug Info';
            }
        });

        // Initialize
        showState('upload');
    </script>
</body>
</html> 